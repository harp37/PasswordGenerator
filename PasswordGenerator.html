<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Advanced Password Generator</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root{
      /* Base */
      --bg: #eef6f0;
      --bg2: #dff2e5;
      --panel: rgba(255,255,255,.72);
      --panel2: rgba(255,255,255,.55);
      --text: #0f2a1f;
      --muted: rgba(15,42,31,.65);
      --border: rgba(15,42,31,.16);
      --shadow: 0 18px 45px rgba(0,0,0,.12);
      --shadow2: 0 10px 25px rgba(0,0,0,.10);
      --ring: rgba(17,138,178,.35);

      /* Accent */
      --accent: #0c7f5a;
      --accent2: #118ab2;
      --accent3: #06d6a0;

      /* Status */
      --weak: #ff6b6b;
      --medium: #ffd166;
      --strong: #06d6a0;
      --very-strong: #118ab2;

      /* Radius / spacing */
      --r-lg: 18px;
      --r-md: 12px;
      --r-sm: 10px;
      --pad: 18px;
      --pad2: 14px;

      /* Typography */
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    /* Dark theme overrides */
    [data-theme="dark"]{
      --bg: #0f141c;
      --bg2: #0f1a22;
      --panel: rgba(25,32,44,.72);
      --panel2: rgba(25,32,44,.55);
      --text: #e9edf6;
      --muted: rgba(233,237,246,.62);
      --border: rgba(233,237,246,.14);
      --shadow: 0 18px 45px rgba(0,0,0,.42);
      --shadow2: 0 10px 25px rgba(0,0,0,.36);
      --ring: rgba(138,180,184,.30);

      --accent: #8ab4b8;
      --accent2: #5daee0;
      --accent3: #58d2a9;
    }

    /* High-contrast theme */
    [data-theme="contrast"]{
      --bg: #000;
      --bg2: #000;
      --panel: rgba(0,0,0,.92);
      --panel2: rgba(0,0,0,.86);
      --text: #fff;
      --muted: rgba(255,255,255,.78);
      --border: rgba(255,255,255,.28);
      --shadow: none;
      --shadow2: none;
      --ring: rgba(255,255,255,.35);

      --accent: #00ffa8;
      --accent2: #22a7ff;
      --accent3: #00ffa8;
      --weak: #ff4d4d;
      --medium: #ffd400;
      --strong: #00ffa8;
      --very-strong: #22a7ff;
    }

    *{ box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin: 0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(900px 500px at 10% 0%, rgba(6,214,160,.20), transparent 55%),
        radial-gradient(700px 420px at 90% 10%, rgba(17,138,178,.20), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg2));
    }

    /* Subtle background texture (no external assets) */
    body:before{
      content:"";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background:
        radial-gradient(circle at 10% 20%, rgba(255,255,255,.12), transparent 35%),
        radial-gradient(circle at 80% 30%, rgba(255,255,255,.08), transparent 40%),
        radial-gradient(circle at 35% 80%, rgba(255,255,255,.08), transparent 40%);
      opacity: .55;
      mix-blend-mode: overlay;
    }

    a{ color: inherit; text-decoration: none; }
    .wrap{
      max-width: 1120px;
      margin: 0 auto;
      padding: 26px 18px 44px;
      position: relative;
      z-index: 1;
    }

    /* Top bar */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
      margin-bottom: 18px;
    }
    .brand{
      display:flex; align-items:center; gap: 12px;
      min-width: 240px;
    }
    .logo{
      width: 42px; height: 42px;
      border-radius: 14px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), transparent 35%),
        linear-gradient(135deg, var(--accent3), var(--accent2));
      box-shadow: var(--shadow2);
      position: relative;
      overflow:hidden;
      flex: 0 0 auto;
    }
    .logo:after{
      content:"";
      position:absolute; inset: -20px;
      background: conic-gradient(from 220deg, transparent 0 60%, rgba(255,255,255,.18) 60% 70%, transparent 70% 100%);
      animation: spin 6s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg);} }

    .brand h1{
      margin:0;
      font-size: 18px;
      letter-spacing: .2px;
    }
    .brand p{
      margin:2px 0 0;
      font-size: 12.5px;
      color: var(--muted);
    }

    .top-actions{
      display:flex; align-items:center; gap: 10px; flex-wrap: wrap;
      justify-content:flex-end;
    }

    /* Segmented theme control */
    .seg{
      display:inline-flex;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: var(--panel2);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .seg button{
      appearance:none;
      border:0;
      background: transparent;
      color: var(--muted);
      padding: 8px 10px;
      font-size: 12.5px;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap: 7px;
      line-height: 1;
      transition: background .18s ease, color .18s ease;
      white-space: nowrap;
    }
    .seg button[aria-pressed="true"]{
      background: rgba(12,127,90,.14);
      color: var(--text);
    }
    [data-theme="dark"] .seg button[aria-pressed="true"]{
      background: rgba(93,174,224,.14);
    }
    [data-theme="contrast"] .seg button[aria-pressed="true"]{
      outline: 2px solid rgba(255,255,255,.32);
      outline-offset: -2px;
      background: rgba(255,255,255,.08);
    }

    .kbdhint{
      font-size: 12.5px;
      color: var(--muted);
      border: 1px solid var(--border);
      border-radius: 999px;
      background: var(--panel2);
      backdrop-filter: blur(10px);
      padding: 8px 10px;
      box-shadow: var(--shadow2);
      white-space: nowrap;
    }

    /* Main grid */
    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap: 16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .brand{ min-width: 0; }
      .topbar{ align-items:flex-start; }
    }

    /* Panels */
    .panel{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--r-lg);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      overflow:hidden;
    }
    .panel .hd{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 16px 18px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.22), transparent);
    }
    [data-theme="dark"] .panel .hd{
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
    }
    .hd .title{
      display:flex; flex-direction:column; gap: 2px;
    }
    .hd .title strong{
      font-size: 14px; letter-spacing: .25px;
    }
    .hd .title span{
      font-size: 12.5px; color: var(--muted);
    }
    .hd .mini-actions{
      display:flex; gap: 8px; align-items:center; flex-wrap: wrap;
      justify-content:flex-end;
    }

    .content{ padding: 16px 18px 18px; }

    /* Form controls */
    .row{ display:flex; gap: 12px; align-items:center; flex-wrap: wrap; }
    .col{ flex: 1 1 220px; min-width: 220px; }
    .col.shrink{ flex: 0 1 auto; min-width: 160px; }

    .lbl{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      font-size: 12.5px;
      color: var(--muted);
      margin-bottom: 8px;
    }
    .lbl b{ color: var(--text); font-weight: 650; letter-spacing:.2px; }

    .control{
      width: 100%;
      border: 1px solid var(--border);
      border-radius: var(--r-md);
      background: rgba(255,255,255,.48);
      color: var(--text);
      padding: 10px 12px;
      outline:none;
      transition: box-shadow .18s ease, border-color .18s ease, background .18s ease;
    }
    [data-theme="dark"] .control{ background: rgba(25,32,44,.58); }
    [data-theme="contrast"] .control{ background: #000; }
    .control:focus{
      border-color: rgba(17,138,178,.55);
      box-shadow: 0 0 0 4px var(--ring);
    }
    .num{
      width: 120px;
      font-variant-numeric: tabular-nums;
    }

    /* Range slider */
    .range-wrap{
      display:flex;
      gap: 12px;
      align-items:center;
    }
    input[type="range"]{
      flex: 1 1 auto;
      width: 100%;
      accent-color: var(--accent2);
    }

    /* Toggle chips */
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      margin-top: 2px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.50);
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, background .18s ease, border-color .18s ease;
    }
    [data-theme="dark"] .chip{ background: rgba(25,32,44,.58); }
    [data-theme="contrast"] .chip{ background: #000; }
    .chip:active{ transform: translateY(1px); }
    .chip input{
      width: 18px; height: 18px;
      accent-color: var(--accent);
    }
    .chip span{ font-size: 13px; color: var(--text); }

    /* Buttons */
    .btn{
      appearance:none;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.52);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition: transform .08s ease, background .18s ease, border-color .18s ease, box-shadow .18s ease;
      display:inline-flex;
      align-items:center;
      gap: 10px;
      font-weight: 650;
      letter-spacing: .15px;
    }
    [data-theme="dark"] .btn{ background: rgba(25,32,44,.62); }
    [data-theme="contrast"] .btn{ background: #000; }
    .btn:hover{ border-color: rgba(17,138,178,.35); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      border-color: rgba(12,127,90,.25);
      background: linear-gradient(135deg, rgba(6,214,160,.35), rgba(17,138,178,.25));
    }
    .btn.primary:hover{
      border-color: rgba(17,138,178,.52);
      box-shadow: 0 0 0 4px var(--ring);
    }
    .btn.danger{
      border-color: rgba(255,107,107,.35);
      background: rgba(255,107,107,.14);
    }
    .btn:disabled{
      opacity: .55;
      cursor: not-allowed;
      transform: none;
    }
    .btn.small{
      padding: 8px 10px;
      border-radius: 11px;
      font-size: 12.5px;
      font-weight: 600;
      gap: 8px;
    }

    /* Accordion (Advanced) */
    .accordion{
      margin-top: 14px;
      border: 1px solid var(--border);
      border-radius: var(--r-lg);
      overflow:hidden;
      background: rgba(255,255,255,.40);
    }
    [data-theme="dark"] .accordion{ background: rgba(25,32,44,.52); }
    [data-theme="contrast"] .accordion{ background: #000; }
    .acc-hd{
      padding: 12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      cursor:pointer;
      user-select:none;
      gap: 12px;
    }
    .acc-hd strong{ font-size: 13px; letter-spacing:.2px; }
    .acc-hd span{ color: var(--muted); font-size: 12.5px; }
    .acc-body{
      max-height: 0;
      overflow:hidden;
      transition: max-height .26s ease;
      border-top: 1px solid var(--border);
    }
    .acc-body-inner{ padding: 14px 12px 12px; }

    /* Output panel */
    .pwbox{
      border: 1px solid var(--border);
      border-radius: var(--r-lg);
      background: rgba(255,255,255,.52);
      padding: 14px 14px 12px;
    }
    [data-theme="dark"] .pwbox{ background: rgba(25,32,44,.62); }
    [data-theme="contrast"] .pwbox{ background: #000; }

    .pwline{
      display:flex;
      gap: 10px;
      align-items:stretch;
    }
    .pwinput{
      flex: 1 1 auto;
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(255,255,255,.62);
      color: var(--text);
      padding: 12px 12px;
      font-family: var(--mono);
      font-size: 18px;
      letter-spacing: .6px;
      outline:none;
      transition: box-shadow .18s ease, border-color .18s ease;
    }
    [data-theme="dark"] .pwinput{ background: rgba(25,32,44,.72); }
    [data-theme="contrast"] .pwinput{ background: #000; }
    .pwinput:focus{ border-color: rgba(17,138,178,.55); box-shadow: 0 0 0 4px var(--ring); }
    .iconbtn{
      width: 44px;
      min-width: 44px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.58);
      cursor:pointer;
      transition: transform .08s ease, background .18s ease, border-color .18s ease, box-shadow .18s ease;
    }
    [data-theme="dark"] .iconbtn{ background: rgba(25,32,44,.70); }
    [data-theme="contrast"] .iconbtn{ background: #000; }
    .iconbtn:hover{ border-color: rgba(17,138,178,.45); box-shadow: 0 0 0 4px var(--ring); }
    .iconbtn:active{ transform: translateY(1px); }
    .iconbtn:disabled{ opacity:.55; cursor:not-allowed; box-shadow:none; }
    .icon{
      width: 18px; height: 18px;
      display:block;
      fill: none;
      stroke: currentColor;
      stroke-width: 2.2;
      stroke-linecap: round;
      stroke-linejoin: round;
      color: var(--text);
    }

    /* Strength */
    .strength{
      margin-top: 12px;
      display:flex;
      flex-direction:column;
      gap: 8px;
    }
    .strength-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .strength-top .label{
      color: var(--muted);
      font-size: 12.5px;
    }
    .strength-top .label b{ color: var(--text); }
    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 10px;
      background: rgba(255,255,255,.48);
      font-size: 12.5px;
      color: var(--muted);
    }
    [data-theme="dark"] .pill{ background: rgba(25,32,44,.60); }
    [data-theme="contrast"] .pill{ background: #000; }
    .meter{
      height: 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.35);
      overflow:hidden;
      position:relative;
    }
    [data-theme="dark"] .meter{ background: rgba(25,32,44,.50); }
    [data-theme="contrast"] .meter{ background: #000; }
    .meter > div{
      height: 100%;
      width: 0%;
      border-radius: 999px;
      transition: width .25s ease;
    }

    /* Inline validation */
    .msg{
      margin-top: 10px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(255,255,255,.42);
      padding: 10px 12px;
      font-size: 12.5px;
      color: var(--muted);
      display:none;
    }
    [data-theme="dark"] .msg{ background: rgba(25,32,44,.55); }
    [data-theme="contrast"] .msg{ background: #000; }
    .msg.show{ display:block; }
    .msg.error{
      border-color: rgba(255,107,107,.35);
      background: rgba(255,107,107,.14);
      color: rgba(15,42,31,.92);
    }
    [data-theme="dark"] .msg.error{ color: rgba(233,237,246,.92); }
    [data-theme="contrast"] .msg.error{ color: #fff; }

    /* Multiple passwords */
    .list{
      margin-top: 14px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .item{
      display:flex;
      gap: 10px;
      align-items:center;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: var(--r-lg);
      background: rgba(255,255,255,.42);
    }
    [data-theme="dark"] .item{ background: rgba(25,32,44,.54); }
    [data-theme="contrast"] .item{ background: #000; }
    .item input{
      flex: 1 1 auto;
      font-family: var(--mono);
      font-size: 14px;
      letter-spacing: .35px;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.58);
      color: var(--text);
      outline:none;
    }
    [data-theme="dark"] .item input{ background: rgba(25,32,44,.70); }
    [data-theme="contrast"] .item input{ background: #000; }
    .item .acts{ display:flex; gap: 8px; flex-wrap:wrap; justify-content:flex-end; }

    /* History */
    .history{
      display:flex;
      flex-direction:column;
      gap: 10px;
      max-height: 320px;
      overflow:auto;
      padding-right: 4px;
    }
    .hist-row{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      align-items:center;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: var(--r-lg);
      background: rgba(255,255,255,.40);
    }
    [data-theme="dark"] .hist-row{ background: rgba(25,32,44,.54); }
    [data-theme="contrast"] .hist-row{ background: #000; }
    .hist-pw{
      display:flex; flex-direction:column; gap: 6px;
      min-width: 0;
    }
    .hist-pw code{
      font-family: var(--mono);
      font-size: 13.5px;
      letter-spacing: .35px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .hist-pw span{
      color: var(--muted);
      font-size: 12px;
    }
    .hist-acts{ display:flex; gap: 8px; flex-wrap:wrap; justify-content:flex-end; }

    /* Toast */
    .toast{
      position: fixed;
      inset: auto 18px 18px auto;
      min-width: 260px;
      max-width: min(460px, calc(100vw - 36px));
      background: rgba(12,127,90,.92);
      color: white;
      border-radius: 14px;
      padding: 12px 12px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.20);
      opacity: 0;
      transform: translateY(10px);
      transition: opacity .18s ease, transform .18s ease;
      z-index: 9999;
    }
    .toast.show{ opacity: 1; transform: translateY(0); }
    .toast .t-top{ display:flex; align-items:flex-start; justify-content:space-between; gap: 10px; }
    .toast .t-top strong{ font-size: 13px; }
    .toast .t-top button{
      appearance:none; border:0; background: transparent; color: rgba(255,255,255,.88);
      cursor:pointer; padding: 2px 4px; border-radius: 8px;
    }
    .toast .t-msg{ margin-top: 6px; font-size: 12.5px; color: rgba(255,255,255,.92); }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      *{ transition: none !important; animation: none !important; scroll-behavior: auto !important; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand" aria-label="App title">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Advanced Password Generator</h1>
          <p>Generate secure passwords with strength feedback, history, and privacy-friendly local storage.</p>
        </div>
      </div>

      <div class="top-actions">
        <div class="seg" role="group" aria-label="Theme">
          <button id="themeSystemBtn" type="button" aria-pressed="false" title="Match system theme">System</button>
          <button id="themeLightBtn" type="button" aria-pressed="false" title="Light theme">Light</button>
          <button id="themeDarkBtn" type="button" aria-pressed="false" title="Dark theme">Dark</button>
          <button id="themeContrastBtn" type="button" aria-pressed="false" title="High-contrast theme">Contrast</button>
        </div>
        <div class="kbdhint" title="Keyboard shortcuts">
          <b>Generate:</b> Ctrl/⌘ + Enter&nbsp;&nbsp;•&nbsp;&nbsp;<b>Copy:</b> Ctrl/⌘ + C (when focused)
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- Controls -->
      <section class="panel" aria-label="Password settings">
        <div class="hd">
          <div class="title">
            <strong>Settings</strong>
            <span>Choose character sets and fine-tune generation behavior.</span>
          </div>
          <div class="mini-actions">
            <button class="btn small" id="resetBtn" type="button" title="Reset settings to defaults">Reset</button>
          </div>
        </div>

        <div class="content">
          <div class="row">
            <div class="col">
              <div class="lbl">
                <b>Password length</b>
                <span><span id="lenLabel">16</span> chars</span>
              </div>
              <div class="range-wrap">
                <input id="lengthRange" type="range" min="4" max="64" value="16" aria-label="Password length slider">
                <input class="control num" id="length" type="number" min="4" max="64" value="16" aria-label="Password length">
              </div>
            </div>

            <div class="col shrink">
              <div class="lbl"><b>Generate</b><span>Quantity</span></div>
              <input class="control num" id="passwordCount" type="number" min="1" max="10" value="1" aria-label="Number of passwords">
            </div>
          </div>

          <div style="margin-top: 14px;">
            <div class="lbl"><b>Character types</b><span>Pick one or more</span></div>
            <div class="chips" role="group" aria-label="Character types">
              <label class="chip"><input id="useUppercase" type="checkbox" checked><span>Uppercase (A–Z)</span></label>
              <label class="chip"><input id="useLowercase" type="checkbox" checked><span>Lowercase (a–z)</span></label>
              <label class="chip"><input id="useNumbers" type="checkbox" checked><span>Numbers (0–9)</span></label>
              <label class="chip"><input id="useSymbols" type="checkbox"><span>Symbols (!@#$…)</span></label>
            </div>
          </div>

          <div class="accordion" id="advanced">
            <div class="acc-hd" id="advancedToggle" role="button" tabindex="0" aria-expanded="false" aria-controls="advancedBody">
              <div>
                <strong>Advanced options</strong>
                <div style="margin-top: 2px;"><span>Exclusions, requirements, and custom characters</span></div>
              </div>
              <div aria-hidden="true" style="font-size: 12.5px; color: var(--muted);">Toggle</div>
            </div>
            <div class="acc-body" id="advancedBody">
              <div class="acc-body-inner">
                <div class="chips" role="group" aria-label="Advanced toggles">
                  <label class="chip"><input id="excludeSimilar" type="checkbox"><span>Exclude similar (i, l, 1, L, o, 0, O)</span></label>
                  <label class="chip"><input id="excludeAmbiguous" type="checkbox"><span>Exclude ambiguous symbols ({}[]()/…)</span></label>
                  <label class="chip"><input id="requireAll" type="checkbox"><span>Require each selected type</span></label>
                  <label class="chip"><input id="autoCopy" type="checkbox"><span>Auto-copy on generate</span></label>
                  <label class="chip"><input id="autoSave" type="checkbox"><span>Auto-save to history</span></label>
                </div>

                <div style="margin-top: 14px;">
                  <div class="lbl"><b>Custom characters</b><span>Optional</span></div>
                  <input class="control" id="customCharacters" type="text" placeholder="Add any specific characters (e.g., @#-_)" autocomplete="off" spellcheck="false">
                </div>

                <div style="margin-top: 14px;">
                  <div class="lbl"><b>Safety tip</b><span>Local-only</span></div>
                  <div class="msg show" style="display:block;">
                    Passwords and settings are stored locally in your browser (localStorage). Avoid saving passwords here if this device is shared.
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row" style="margin-top: 16px;">
            <button class="btn primary" id="generateBtn" type="button">
              <span aria-hidden="true">Generate</span>
            </button>

            <button class="btn" id="presetBtn" type="button" title="Apply a safer default preset">
              Safer preset
            </button>

            <div style="flex:1 1 auto;"></div>

            <button class="btn danger" id="clearHistoryBtn" type="button" title="Clear all saved history">
              Clear history
            </button>
          </div>

          <div id="inlineMsg" class="msg" role="status" aria-live="polite"></div>
        </div>
      </section>

      <!-- Output -->
      <section class="panel" aria-label="Generated passwords">
        <div class="hd">
          <div class="title">
            <strong>Output</strong>
            <span>Copy, reveal, and save passwords.</span>
          </div>
          <div class="mini-actions">
            <button class="btn small" id="exportBtn" type="button" title="Export generated and saved passwords to a text file">Export</button>
          </div>
        </div>

        <div class="content">
          <div class="pwbox">
            <div class="pwline">
              <input id="password" class="pwinput" type="password" readonly aria-label="Generated password" spellcheck="false">
              <button class="iconbtn" id="revealBtn" type="button" title="Show / hide password" aria-label="Show or hide password">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7S2 12 2 12z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
              </button>
              <button class="iconbtn" id="copyBtn" type="button" title="Copy to clipboard" aria-label="Copy password">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                  <rect x="9" y="9" width="13" height="13" rx="2"></rect>
                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
              </button>
              <button class="iconbtn" id="regenBtn" type="button" title="Generate a new password" aria-label="Regenerate password">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M21 12a9 9 0 1 1-2.64-6.36"></path>
                  <path d="M21 3v6h-6"></path>
                </svg>
              </button>
            </div>

            <div class="strength" aria-label="Strength meter">
              <div class="strength-top">
                <div class="label">
                  <b id="strengthLabel">Strength</b>
                  <span id="strengthText" style="margin-left: 6px;">—</span>
                </div>
                <div class="pill" title="Rough estimate of bits of entropy based on length and selected charset size">
                  <span><b id="entropyBits">0</b> bits</span>
                  <span style="opacity:.7;">•</span>
                  <span id="charsetSize">0 chars</span>
                </div>
              </div>
              <div class="meter" aria-hidden="true"><div id="strengthBar"></div></div>
            </div>

            <div class="row" style="margin-top: 12px;">
              <button class="btn" id="saveBtn" type="button">Save to history</button>
              <button class="btn" id="useFirstBtn" type="button" title="Move focus to the password field">Focus password</button>
            </div>
          </div>

          <div id="multiplePasswords" class="list" aria-label="Additional generated passwords"></div>

          <div style="margin-top: 16px;">
            <div class="lbl"><b>Saved history</b><span id="histCount">0 items</span></div>
            <div class="history" id="historyItems" aria-label="Password history"></div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true">
    <div class="t-top">
      <strong id="toastTitle">Notice</strong>
      <button id="toastCloseBtn" type="button" aria-label="Dismiss notification">✕</button>
    </div>
    <div class="t-msg" id="toastMsg"></div>
  </div>

  <script>
    // --- DOM elements
    const passwordEl = document.getElementById('password');
    const lengthEl = document.getElementById('length');
    const lengthRangeEl = document.getElementById('lengthRange');
    const lenLabelEl = document.getElementById('lenLabel');

    const useUppercaseEl = document.getElementById('useUppercase');
    const useLowercaseEl = document.getElementById('useLowercase');
    const useNumbersEl = document.getElementById('useNumbers');
    const useSymbolsEl = document.getElementById('useSymbols');

    const excludeSimilarEl = document.getElementById('excludeSimilar');
    const excludeAmbiguousEl = document.getElementById('excludeAmbiguous');
    const requireAllEl = document.getElementById('requireAll');
    const autoCopyEl = document.getElementById('autoCopy');
    const autoSaveEl = document.getElementById('autoSave');

    const customCharactersEl = document.getElementById('customCharacters');
    const passwordCountEl = document.getElementById('passwordCount');

    const advancedToggleEl = document.getElementById('advancedToggle');
    const advancedBodyEl = document.getElementById('advancedBody');

    const generateBtn = document.getElementById('generateBtn');
    const regenBtn = document.getElementById('regenBtn');
    const copyBtn = document.getElementById('copyBtn');
    const revealBtn = document.getElementById('revealBtn');
    const saveBtn = document.getElementById('saveBtn');
    const useFirstBtn = document.getElementById('useFirstBtn');
    const resetBtn = document.getElementById('resetBtn');
    const presetBtn = document.getElementById('presetBtn');
    const clearHistoryBtn = document.getElementById('clearHistoryBtn');
    const exportBtn = document.getElementById('exportBtn');

    const strengthBarEl = document.getElementById('strengthBar');
    const strengthTextEl = document.getElementById('strengthText');
    const entropyBitsEl = document.getElementById('entropyBits');
    const charsetSizeEl = document.getElementById('charsetSize');

    const multiplePasswordsEl = document.getElementById('multiplePasswords');
    const historyItemsEl = document.getElementById('historyItems');
    const histCountEl = document.getElementById('histCount');

    const inlineMsgEl = document.getElementById('inlineMsg');

    const toastEl = document.getElementById('toast');
    const toastTitleEl = document.getElementById('toastTitle');
    const toastMsgEl = document.getElementById('toastMsg');
    const toastCloseBtn = document.getElementById('toastCloseBtn');

    const themeSystemBtn = document.getElementById('themeSystemBtn');
    const themeLightBtn = document.getElementById('themeLightBtn');
    const themeDarkBtn = document.getElementById('themeDarkBtn');
    const themeContrastBtn = document.getElementById('themeContrastBtn');

    // --- Character sets
    const UPPERCASE_CHARS = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    const LOWERCASE_CHARS = 'abcdefghijklmnopqrstuvwxyz';
    const NUMBER_CHARS = '0123456789';
    const SYMBOL_CHARS = '!@#$%^&*()_-+=<>?';
    const AMBIGUOUS_CHARS = '{}[]()/\\\'"`~,;:.<>';
    const SIMILAR_CHARS = 'il1Lo0O';

    // --- History
    let passwordHistory = JSON.parse(localStorage.getItem('passwordHistory')) || [];

    let warnedWeakRng = false;

    // --- Secure RNG helpers (crypto)
    function secureRandomInt(maxExclusive){
      if (!Number.isFinite(maxExclusive) || maxExclusive <= 0) return 0;
      const max = Math.floor(maxExclusive);

      // Prefer cryptographically secure randomness. If unavailable, fall back to Math.random
      // (and notify once) to keep the tool usable.
      if (!window.crypto || !crypto.getRandomValues){
        if (!warnedWeakRng){
          warnedWeakRng = true;
          showToast('Secure randomness is not available in this browser context. Results may be less secure.', 'Warning');
        }
        return Math.floor(Math.random() * max);
      }

      const limit = Math.floor(0x100000000 / max) * max;
      const u32 = new Uint32Array(1);
      let r;
      do{
        crypto.getRandomValues(u32);
        r = u32[0];
      } while (r >= limit);
      return r % max;
    }
    function pickChar(str){
      return str.charAt(secureRandomInt(str.length));
    }
    function shuffleString(str){
      const arr = str.split('');
      for (let i = arr.length - 1; i > 0; i--){
        const j = secureRandomInt(i + 1);
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr.join('');
    }
    function uniqueString(str){
      return Array.from(new Set(str.split(''))).join('');
    }

    // --- Theme
    function setTheme(mode){
      // mode: system|light|dark|contrast
      localStorage.setItem('themeMode', mode);
      applyTheme();
    }
    function applyTheme(){
      const mode = localStorage.getItem('themeMode') || 'system';
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = (mode === 'system') ? (prefersDark ? 'dark' : 'light') : mode;

      document.documentElement.setAttribute('data-theme', theme);

      const setPressed = (btn, pressed) => btn.setAttribute('aria-pressed', pressed ? 'true' : 'false');
      setPressed(themeSystemBtn, mode === 'system');
      setPressed(themeLightBtn, mode === 'light');
      setPressed(themeDarkBtn, mode === 'dark');
      setPressed(themeContrastBtn, mode === 'contrast');
    }

    // --- Accordion
    function setAccordion(open){
      advancedToggleEl.setAttribute('aria-expanded', open ? 'true' : 'false');
      if (open){
        advancedBodyEl.style.maxHeight = advancedBodyEl.scrollHeight + 'px';
      } else {
        advancedBodyEl.style.maxHeight = '0px';
      }
      localStorage.setItem('advancedOpen', open ? 'true' : 'false');
    }
    function toggleAccordion(){
      const isOpen = advancedToggleEl.getAttribute('aria-expanded') === 'true';
      setAccordion(!isOpen);
    }

    // --- Toast
    let toastTimer = null;
    function showToast(message, title='Notice'){
      toastTitleEl.textContent = title;
      toastMsgEl.textContent = message;
      toastEl.classList.add('show');
      if (toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(() => toastEl.classList.remove('show'), 2800);
    }
    function hideToast(){
      toastEl.classList.remove('show');
      if (toastTimer) clearTimeout(toastTimer);
      toastTimer = null;
    }

    // --- Inline message
    function showInline(message, kind='info'){
      inlineMsgEl.textContent = message;
      inlineMsgEl.classList.add('show');
      inlineMsgEl.classList.toggle('error', kind === 'error');
    }
    function clearInline(){
      inlineMsgEl.textContent = '';
      inlineMsgEl.classList.remove('show', 'error');
    }

    // --- Settings persistence
    function saveSettings(){
      const settings = {
        length: parseInt(lengthEl.value, 10),
        useUppercase: useUppercaseEl.checked,
        useLowercase: useLowercaseEl.checked,
        useNumbers: useNumbersEl.checked,
        useSymbols: useSymbolsEl.checked,
        excludeSimilar: excludeSimilarEl.checked,
        excludeAmbiguous: excludeAmbiguousEl.checked,
        requireAll: requireAllEl.checked,
        customCharacters: customCharactersEl.value,
        passwordCount: parseInt(passwordCountEl.value, 10),
        autoCopy: autoCopyEl.checked,
        autoSave: autoSaveEl.checked
      };
      localStorage.setItem('passwordSettings', JSON.stringify(settings));
    }
    function loadSettings(){
      const saved = JSON.parse(localStorage.getItem('passwordSettings') || 'null');
      if (!saved) return;

      lengthEl.value = clamp(saved.length ?? 16, 4, 64);
      lengthRangeEl.value = lengthEl.value;
      passwordCountEl.value = clamp(saved.passwordCount ?? 1, 1, 10);

      useUppercaseEl.checked = saved.useUppercase ?? true;
      useLowercaseEl.checked = saved.useLowercase ?? true;
      useNumbersEl.checked = saved.useNumbers ?? true;
      useSymbolsEl.checked = saved.useSymbols ?? false;

      excludeSimilarEl.checked = !!saved.excludeSimilar;
      excludeAmbiguousEl.checked = !!saved.excludeAmbiguous;
      requireAllEl.checked = !!saved.requireAll;
      autoCopyEl.checked = !!saved.autoCopy;
      autoSaveEl.checked = !!saved.autoSave;

      customCharactersEl.value = saved.customCharacters ?? '';
      syncLengthLabel();
    }
    function clamp(n, min, max){
      n = Number.isFinite(+n) ? +n : min;
      return Math.max(min, Math.min(max, n));
    }

    function resetSettings(){
      localStorage.removeItem('passwordSettings');
      lengthEl.value = 16;
      lengthRangeEl.value = 16;
      passwordCountEl.value = 1;

      useUppercaseEl.checked = true;
      useLowercaseEl.checked = true;
      useNumbersEl.checked = true;
      useSymbolsEl.checked = false;

      excludeSimilarEl.checked = false;
      excludeAmbiguousEl.checked = false;
      requireAllEl.checked = false;
      autoCopyEl.checked = false;
      autoSaveEl.checked = false;

      customCharactersEl.value = '';
      syncLengthLabel();
      clearInline();
      showToast('Settings reset to defaults.', 'Reset');
    }

    // --- Build charset
    function buildCharset(){
      const useUppercase = useUppercaseEl.checked;
      const useLowercase = useLowercaseEl.checked;
      const useNumbers = useNumbersEl.checked;
      const useSymbols = useSymbolsEl.checked;

      const excludeSimilar = excludeSimilarEl.checked;
      const excludeAmbiguous = excludeAmbiguousEl.checked;

      const customCharsRaw = customCharactersEl.value || '';
      const customChars = uniqueString(customCharsRaw);

      let groups = [];
      if (useUppercase) groups.push({ name: 'uppercase', chars: UPPERCASE_CHARS });
      if (useLowercase) groups.push({ name: 'lowercase', chars: LOWERCASE_CHARS });
      if (useNumbers) groups.push({ name: 'numbers', chars: NUMBER_CHARS });

      if (useSymbols){
        let sym = SYMBOL_CHARS;
        if (excludeAmbiguous){
          sym = sym.split('').filter(c => !AMBIGUOUS_CHARS.includes(c)).join('');
        }
        groups.push({ name: 'symbols', chars: sym });
      }

      if (customChars){
        groups.push({ name: 'custom', chars: customChars });
      }

      // Apply excludeSimilar to all groups
      if (excludeSimilar){
        groups = groups.map(g => ({
          ...g,
          chars: g.chars.split('').filter(c => !SIMILAR_CHARS.includes(c)).join('')
        })).filter(g => g.chars.length > 0);
      }

      // Merge groups into final charset
      let charset = groups.map(g => g.chars).join('');
      charset = uniqueString(charset);

      return { charset, groups, customChars };
    }

    // --- Validation and computed values
    function computeEntropyBits(length, charsetSize){
      if (!length || !charsetSize) return 0;
      // log2(charsetSize^length) = length * log2(charsetSize)
      const bits = length * (Math.log(charsetSize) / Math.log(2));
      return Math.round(bits);
    }

    function validateSettings({charset, groups}){
      const length = clamp(lengthEl.value, 4, 64);
      const requireAll = requireAllEl.checked;

      if (groups.length === 0 || charset.length === 0){
        return { ok: false, message: 'Select at least one character type (or add custom characters).', kind: 'error' };
      }
      if (length < 4){
        return { ok: false, message: 'Password length must be at least 4.', kind: 'error' };
      }
      if (requireAll && length < groups.length){
        return { ok: false, message: `Length must be at least ${groups.length} to include one character from each selected set.`, kind: 'error' };
      }
      return { ok: true };
    }

    // --- Strength scoring (0..100, simple heuristic)
    function scorePassword(password){
      const length = password.length;
      const hasUppercase = /[A-Z]/.test(password);
      const hasLowercase = /[a-z]/.test(password);
      const hasNumbers = /\d/.test(password);
      const hasSymbols = /[^A-Za-z0-9]/.test(password);

      let strength = 0;
      strength += Math.min(length * 2.5, 40);

      if (hasUppercase) strength += 10;
      if (hasLowercase) strength += 10;
      if (hasNumbers) strength += 10;
      if (hasSymbols) strength += 10;

      let types = 0;
      if (hasUppercase) types++;
      if (hasLowercase) types++;
      if (hasNumbers) types++;
      if (hasSymbols) types++;

      if (types >= 3) strength += 10;
      if (types === 4) strength += 10;

      strength = Math.max(0, Math.min(100, Math.round(strength)));
      return strength;
    }

    function applyStrengthUI(password, charsetSize){
      const strength = scorePassword(password);
      const length = password.length;

      // bar width + color
      strengthBarEl.style.width = strength + '%';

      let label = '—';
      let color = getComputedStyle(document.documentElement).getPropertyValue('--weak').trim();
      if (strength < 40){
        label = 'Weak';
        color = getComputedStyle(document.documentElement).getPropertyValue('--weak').trim();
      } else if (strength < 60){
        label = 'Medium';
        color = getComputedStyle(document.documentElement).getPropertyValue('--medium').trim();
      } else if (strength < 80){
        label = 'Strong';
        color = getComputedStyle(document.documentElement).getPropertyValue('--strong').trim();
      } else {
        label = 'Very strong';
        color = getComputedStyle(document.documentElement).getPropertyValue('--very-strong').trim();
      }

      strengthTextEl.textContent = `${label} (${strength}/100)`;
      strengthBarEl.style.background = color;

      const bits = computeEntropyBits(length, charsetSize);
      entropyBitsEl.textContent = bits.toString();
      charsetSizeEl.textContent = `${charsetSize} chars`;
    }

    // --- Password generation
    function generateOnePassword(length, charset, groups, requireAll){
      let pwd = '';

      if (requireAll){
        // one from each group, then fill the rest
        for (const g of groups){
          pwd += pickChar(g.chars);
        }
      }

      while (pwd.length < length){
        pwd += pickChar(charset);
      }

      // Trim (in case requireAll groups > length, already validated, but safe)
      if (pwd.length > length){
        pwd = pwd.slice(0, length);
      }

      return shuffleString(pwd);
    }

    function syncLengthLabel(){
      const v = clamp(lengthEl.value, 4, 64);
      lenLabelEl.textContent = v;
      lengthRangeEl.value = v;
    }

    async function copyText(text){
      try{
        await navigator.clipboard.writeText(text);
        return true;
      } catch (e){
        // Fallback for older contexts
        try{
          const ta = document.createElement('textarea');
          ta.value = text;
          ta.setAttribute('readonly', '');
          ta.style.position = 'fixed';
          ta.style.opacity = '0';
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          ta.remove();
          return true;
        } catch (e2){
          return false;
        }
      }
    }

    function renderMultiple(passwords){
      multiplePasswordsEl.innerHTML = '';
      if (passwords.length <= 1) return;

      for (let i = 1; i < passwords.length; i++){
        const pw = passwords[i];

        const row = document.createElement('div');
        row.className = 'item';

        const input = document.createElement('input');
        input.type = 'text';
        input.readOnly = true;
        input.value = pw;
        input.setAttribute('aria-label', `Generated password ${i+1}`);

        const acts = document.createElement('div');
        acts.className = 'acts';

        const copy = document.createElement('button');
        copy.className = 'btn small';
        copy.type = 'button';
        copy.textContent = 'Copy';
        copy.onclick = async () => {
          const ok = await copyText(pw);
          showToast(ok ? 'Password copied.' : 'Copy failed. Your browser may block clipboard access.', ok ? 'Copied' : 'Clipboard');
        };

        const save = document.createElement('button');
        save.className = 'btn small';
        save.type = 'button';
        save.textContent = 'Save';
        save.onclick = () => {
          addToHistory(pw);
          showToast('Password saved to history.', 'Saved');
        };

        acts.appendChild(copy);
        acts.appendChild(save);
        row.appendChild(input);
        row.appendChild(acts);
        multiplePasswordsEl.appendChild(row);
      }
    }

    function generatePasswords(){
      clearInline();

      // sanitize and sync controls
      lengthEl.value = clamp(lengthEl.value, 4, 64);
      passwordCountEl.value = clamp(passwordCountEl.value, 1, 10);
      syncLengthLabel();

      const length = parseInt(lengthEl.value, 10);
      const count = parseInt(passwordCountEl.value, 10);

      const { charset, groups } = buildCharset();
      const validation = validateSettings({ charset, groups });

      const bits = computeEntropyBits(length, charset.length);
      entropyBitsEl.textContent = bits.toString();
      charsetSizeEl.textContent = `${charset.length} chars`;

      generateBtn.disabled = !validation.ok;
      regenBtn.disabled = !validation.ok;
      copyBtn.disabled = !validation.ok;

      if (!validation.ok){
        passwordEl.value = '';
        passwordEl.type = 'password';
        applyStrengthUI('', charset.length);
        renderMultiple(['']);
        showInline(validation.message, validation.kind);
        return;
      }

      const requireAll = requireAllEl.checked;
      const passwords = [];
      for (let i = 0; i < count; i++){
        passwords.push(generateOnePassword(length, charset, groups, requireAll));
      }

      passwordEl.value = passwords[0];
      applyStrengthUI(passwords[0], charset.length);
      renderMultiple(passwords);

      if (autoCopyEl.checked){
        copyText(passwords[0]).then(ok => {
          showToast(ok ? 'Copied to clipboard.' : 'Copy failed. Your browser may block clipboard access.', ok ? 'Copied' : 'Clipboard');
        });
      }

      if (autoSaveEl.checked){
        addToHistory(passwords[0]);
      }

      saveSettings();
    }

    // --- History management
    function addToHistory(password){
      const entry = {
        password,
        timestamp: new Date().toISOString(),
        id: Date.now() + '-' + secureRandomInt(1_000_000)
      };
      passwordHistory.unshift(entry);
      if (passwordHistory.length > 40) passwordHistory.pop();
      localStorage.setItem('passwordHistory', JSON.stringify(passwordHistory));
      updateHistory();
    }

    function formatTimestamp(iso){
      const d = new Date(iso);
      const date = d.toLocaleDateString();
      const time = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      return `${date} ${time}`;
    }

    function updateHistory(){
      historyItemsEl.innerHTML = '';
      histCountEl.textContent = `${passwordHistory.length} item${passwordHistory.length === 1 ? '' : 's'}`;

      if (passwordHistory.length === 0){
        const empty = document.createElement('div');
        empty.className = 'msg show';
        empty.style.display = 'block';
        empty.textContent = 'No saved passwords yet.';
        historyItemsEl.appendChild(empty);
        return;
      }

      for (const entry of passwordHistory){
        const row = document.createElement('div');
        row.className = 'hist-row';

        const left = document.createElement('div');
        left.className = 'hist-pw';

        const code = document.createElement('code');
        code.textContent = entry.password;

        const meta = document.createElement('span');
        meta.textContent = formatTimestamp(entry.timestamp);

        left.appendChild(code);
        left.appendChild(meta);

        const acts = document.createElement('div');
        acts.className = 'hist-acts';

        const use = document.createElement('button');
        use.className = 'btn small';
        use.type = 'button';
        use.textContent = 'Use';
        use.onclick = () => {
          passwordEl.value = entry.password;
          applyStrengthUI(entry.password, buildCharset().charset.length);
          passwordEl.focus();
          showToast('Loaded into the output field.', 'Loaded');
        };

        const copy = document.createElement('button');
        copy.className = 'btn small';
        copy.type = 'button';
        copy.textContent = 'Copy';
        copy.onclick = async () => {
          const ok = await copyText(entry.password);
          showToast(ok ? 'Password copied.' : 'Copy failed.', ok ? 'Copied' : 'Clipboard');
        };

        const del = document.createElement('button');
        del.className = 'btn small danger';
        del.type = 'button';
        del.textContent = 'Delete';
        del.onclick = () => {
          passwordHistory = passwordHistory.filter(p => p.id !== entry.id);
          localStorage.setItem('passwordHistory', JSON.stringify(passwordHistory));
          updateHistory();
        };

        acts.appendChild(use);
        acts.appendChild(copy);
        acts.appendChild(del);

        row.appendChild(left);
        row.appendChild(acts);
        historyItemsEl.appendChild(row);
      }
    }

    function clearHistory(){
      if (passwordHistory.length === 0){
        showToast('History is already empty.', 'History');
        return;
      }
      // lightweight confirmation without blocking dialogs: require second click within 3s
      if (!clearHistoryBtn.dataset.armed){
        clearHistoryBtn.dataset.armed = 'true';
        clearHistoryBtn.textContent = 'Confirm clear';
        showToast('Click “Confirm clear” again to remove all saved passwords.', 'Confirm');
        setTimeout(() => {
          clearHistoryBtn.dataset.armed = '';
          clearHistoryBtn.textContent = 'Clear history';
        }, 3000);
        return;
      }
      passwordHistory = [];
      localStorage.setItem('passwordHistory', JSON.stringify(passwordHistory));
      clearHistoryBtn.dataset.armed = '';
      clearHistoryBtn.textContent = 'Clear history';
      updateHistory();
      showToast('History cleared.', 'History');
    }

    function exportPasswords(){
      const current = passwordEl.value ? [`Current: ${passwordEl.value}`] : [];
      const generatedExtras = Array.from(multiplePasswordsEl.querySelectorAll('input')).map(i => i.value);
      const saved = passwordHistory.map(e => `[${formatTimestamp(e.timestamp)}] ${e.password}`);

      const lines = [
        'Password Generator Export',
        `Exported: ${new Date().toISOString()}`,
        '',
        ...current,
        ...(generatedExtras.length ? ['','Additional generated:', ...generatedExtras.map(p => '  ' + p)] : []),
        '',
        'Saved history:',
        ...(saved.length ? saved : ['(empty)']),
        ''
      ];

      const blob = new Blob([lines.join('\n')], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = 'passwords-export.txt';
      document.body.appendChild(a);
      a.click();
      a.remove();

      setTimeout(() => URL.revokeObjectURL(url), 1000);
      showToast('Export downloaded.', 'Export');
    }

    function applySaferPreset(){
      // Reasonable defaults:
      // - length 20
      // - uppercase/lowercase/numbers on
      // - symbols optional but off by default for compatibility; user can toggle
      // - exclude similar on
      // - require all on
      // - passwordCount 1
      lengthEl.value = 20;
      lengthRangeEl.value = 20;
      passwordCountEl.value = 1;

      useUppercaseEl.checked = true;
      useLowercaseEl.checked = true;
      useNumbersEl.checked = true;
      // keep user's symbol preference if already on; otherwise off
      // (compatible with more login forms)
      excludeSimilarEl.checked = true;
      requireAllEl.checked = true;

      syncLengthLabel();
      saveSettings();
      showToast('Applied safer preset (20 chars, exclude similar, require all).', 'Preset');
      generatePasswords();
    }

    // --- Actions
    async function copyMainPassword(){
      const pw = passwordEl.value;
      if (!pw){
        showToast('No password to copy.', 'Clipboard');
        return;
      }
      const ok = await copyText(pw);
      showToast(ok ? 'Password copied.' : 'Copy failed. Your browser may block clipboard access.', ok ? 'Copied' : 'Clipboard');
      passwordEl.focus();
      passwordEl.select();
    }

    function saveMainPassword(){
      const pw = passwordEl.value;
      if (!pw){
        showToast('No password to save.', 'History');
        return;
      }
      addToHistory(pw);
      showToast('Password saved to history.', 'Saved');
    }

    function toggleReveal(){
      const isHidden = passwordEl.type === 'password';
      passwordEl.type = isHidden ? 'text' : 'password';
      showToast(isHidden ? 'Password revealed.' : 'Password hidden.', 'Visibility');
      passwordEl.focus();
      passwordEl.select();
    }

    // --- Wiring
    function bindEvents(){
      // theme buttons
      themeSystemBtn.addEventListener('click', () => setTheme('system'));
      themeLightBtn.addEventListener('click', () => setTheme('light'));
      themeDarkBtn.addEventListener('click', () => setTheme('dark'));
      themeContrastBtn.addEventListener('click', () => setTheme('contrast'));

      // accordion
      advancedToggleEl.addEventListener('click', toggleAccordion);
      advancedToggleEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' '){
          e.preventDefault();
          toggleAccordion();
        }
      });

      // sync length slider/number
      lengthRangeEl.addEventListener('input', () => {
        lengthEl.value = lengthRangeEl.value;
        syncLengthLabel();
        generatePasswords();
      });
      lengthEl.addEventListener('input', () => {
        lengthEl.value = clamp(lengthEl.value, 4, 64);
        lengthRangeEl.value = lengthEl.value;
        syncLengthLabel();
        generatePasswords();
      });

      // other settings -> live validate + regenerate
      const regenOnChange = () => generatePasswords();
      [
        useUppercaseEl, useLowercaseEl, useNumbersEl, useSymbolsEl,
        excludeSimilarEl, excludeAmbiguousEl, requireAllEl,
        passwordCountEl, customCharactersEl, autoCopyEl, autoSaveEl
      ].forEach(el => el.addEventListener('input', regenOnChange));

      // primary actions
      generateBtn.addEventListener('click', generatePasswords);
      regenBtn.addEventListener('click', generatePasswords);
      copyBtn.addEventListener('click', copyMainPassword);
      revealBtn.addEventListener('click', toggleReveal);
      saveBtn.addEventListener('click', saveMainPassword);
      useFirstBtn.addEventListener('click', () => { passwordEl.focus(); passwordEl.select(); });

      resetBtn.addEventListener('click', () => { resetSettings(); generatePasswords(); });
      presetBtn.addEventListener('click', applySaferPreset);
      clearHistoryBtn.addEventListener('click', clearHistory);
      exportBtn.addEventListener('click', exportPasswords);

      toastCloseBtn.addEventListener('click', hideToast);

      // keyboard shortcut: Ctrl/⌘+Enter to generate
      window.addEventListener('keydown', (e) => {
        const isMac = navigator.platform.toLowerCase().includes('mac');
        const mod = isMac ? e.metaKey : e.ctrlKey;

        if (mod && e.key === 'Enter'){
          e.preventDefault();
          generatePasswords();
        }

        // Copy shortcut: only when password field is focused
        if (mod && (e.key === 'c' || e.key === 'C') && document.activeElement === passwordEl){
          e.preventDefault();
          copyMainPassword();
        }

        // Escape closes toast
        if (e.key === 'Escape'){
          hideToast();
        }
      });

      // react to system theme changes if in system mode
      if (window.matchMedia){
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
          if ((localStorage.getItem('themeMode') || 'system') === 'system') applyTheme();
        });
      }

      // adjust accordion height on resize (only if open)
      window.addEventListener('resize', () => {
        if (advancedToggleEl.getAttribute('aria-expanded') === 'true'){
          advancedBodyEl.style.maxHeight = advancedBodyEl.scrollHeight + 'px';
        }
      });
    }

    function init(){
      applyTheme();
      loadSettings();

      const advancedOpen = localStorage.getItem('advancedOpen') === 'true';
      setAccordion(advancedOpen);

      updateHistory();
      bindEvents();
      syncLengthLabel();
      generatePasswords();
    }

    window.addEventListener('load', init);
  </script>
</body>
</html>
